<!DOCTYPE html>
<html>
<script type="text/javascript">
    //window.HTMLElement =null;
    //chrome.exe -allow-fi le-access-from-files
</script>
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link type="text/css" rel="stylesheet" href="css/theme.css"/>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/mootools-core-1.4.5.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/menus.js"></script>
    <script type="text/javascript" src="js/dom.js"></script>
    <script type="text/javascript" src="js/node.js"></script>
    <script type="text/javascript" src="js/operation.js"></script>
    <script type="text/javascript" src="js/gl-matrix.js"></script>
    <script type="text/javascript" src="js/sprintf.js"></script>
</head>
<body>
<div class='chart'>
</div>
<div id='input' class="floating">
    <input type="text" class="textedit">
</div>
<div id='search' class="floating">
    <input type="text" class="textedit">
</div>
<script type="text/javascript">
// ui element types
var Target = {
    TABLE: 'table',
    FIELD: 'field',
    LINK: 'link',
    DIALOG: 'dialog'
}
var ActionTypes = {
    MOUSE_OVER: 'mouseover',
    MOUSE_OUT: 'mouseout',
    MOUSE_DOWN: 'mousedown',
    MOUSE_UP: 'mouseup',
    MOUSE_MOVE: 'mousemove',
    MOUSE_CLICK: 'click',

    KEY_DOWN: 'keydown',
    KEY_UP: 'keyup'
}
// global mouse event
var ControlType = {
    SVG_DOWN_BEGIN: 'svgDownB',
    SVG_DOWN_END: 'svgDownE',
    SVG_UP_BEGIN: 'svgUpB',
    SVG_UP_END: 'svgUpE',
    SVG_MOVE: 'svgMove',
    SVG_OVER_BEGIN: 'svgOverB',
    SVG_OVER_END: 'svgOverE',
    SVG_BG_OUT: 'svgBgOut',
    SVG_BG_OVER: 'svgBgOver'
}
function _r(key) {
    return key + '_r';
}
for (var i in ControlType) {
    ControlType[i + '_RIGHT'] = ControlType[i] + '_r';
}
var ControlKeys = (function () {
    var keys = {};
    for (var i in ControlType) {
        keys[ControlType[i]] = i;
    }
    return keys;
})();

// ==========================
// function
// ==========================
function listenSvg(id) {
    return function () {
        uiMgr.handleEvent({'id': id});
    }
}
function listenEvent(event) {
    return function () {
        uiMgr.handle({id: event, target: this});
    }
}
function join() {
    return Array.prototype.slice.call(arguments, 0).join('.');
}
// ==========================
// items in left
// ==========================
/**
 * {id: 'int', init: 'edit.name' }
 */
function Component(p) {
    Node.call(this, p);
}
_node(Component, Node);
Component.prototype.prefer = {
    width: 200,
    height: 24,
    prefix: 8
}
Component.prototype.getName = function () {
    return this.id;
}
Component.prototype.createView = function () {
    return this.rootView().append('svg:g')
            .classed('comp', true);
}
Component.prototype.enter = function (data) {
    var w = this.prefer.width;
    var h = this.prefer.height;
    var pre = this.prefer.prefix;

    this.bg = this.view.append('svg:rect')
            .attr({width: w, height: h});
    this.text = this.view.append('svg:text')
            .attr({x: pre, y: h, dy: -6})
            .text(data.id);
    this.topline = this.view.append('path')
            .attr('d', sprintf('M0,0 l%f,0', w))
            .classed('topline', true);
}
Component.prototype.update = function (data) {
    this.text.text(data.id);
}
Component.prototype.show = function () {
    this.view.classed({'show': true, 'hide': false});
}
Component.prototype.hide = function () {
    this.view.classed({'show': false, 'hide': true});
}
Component.prototype.match = function (text) {
    if (!text || text.length == 0) {
        this.text.text(this.data.id);
        return 0;
    } else {
        var id = 0;
        this.text.childNodes().remove();
        var start = 0;
        var end = -1;
        var index = 0;
        var content = this.data.id;
        for (var i = 0, l = text.length; i < l; i++) {
            var c = text.charAt(i);
            if ((index = content.indexOf(c, end)) != -1) {
                if (index > end) {
                    if (end > start) {
                        id += (1 << (end - start + 1));
                        this.text.append('tspan').classed('light', true).text(content.substring(start, end));
                        start = end;
                    }
                    if (index > start) {
                        //id -= (1 << (index - start));
                        this.text.append('tspan').text(content.substring(start, index));
                        start = index;
                    }
                }
                end = index + 1;
            } else {
                break;
            }
        }
        if (end > start) {
            id += (1 << (end - start + 1));
            this.text.append('tspan').classed('light', true).text(content.substring(start, end));
            start = end;
        }
        if (content.length > start) {
            if (start > 0) {
                //id -= (1 << (content.length - start));
                this.text.append('tspan').text(content.substring(start));
            } else {
                id = 0;
                this.text.text(content);
            }
        }
        return id;
    }
}
Component.prototype.width = function (w) {
    this.bg.attr('width', w);
    this.topline.attr('d', sprintf('M0,0 l%f,0', w));
}
Component.prototype.position = function (x, y) {
    this.view.attr('transform', sprintf('translate(%f,%f)', x, y));
}
function ComponentGroup(container, parent, title) {
    Node.call(this, parent);

    this.container = container;

    this._expand = true;
    var p = this.prefer;

    this.view = parent.view.append('svg:g');

    // title
    this.title = this.view.append('g')
            .classed('expand', true)
            .on('click', this.expand, this);
    this.titlebg = this.title.append('svg:rect')
            .attr({width: p.width, height: p.title});
    this.text = this.title.append('svg:text')
            .attr({x: p.width / 2, y: p.title, dy: -6})
            .text(title);

    // decorate
    this.topline = this.title.append('path')
            .attr('d', sprintf('M0,%f l%f,0', this.prefer['topline-stroke-width'] / 2, p.width))
            .classed('topline', true);

    // children
    this.items = new this.components(this, this.view.append('g').classed('comps', true));
}
_extends(ComponentGroup, Node);
/**
 * anonymous container class
 * @type {*}
 */
ComponentGroup.prototype.components = Node.createContainer(Component, {
    constructor: function (p, view) {
        ListNode.call(this, p);
        this.view = view;
        this._height = 0;
    },
    width: function (w) {
        this.getChildren().each(function (node) {
            node.node().width(w);
        });
    },
    position: function (x, y) {
        this.view.attr('transform', sprintf('translate(%f,%f)', x, y));
    },
    filter: function (key) {
        var children = this.getChildren();
        var nodes = children.nodes();
        nodes.each(function (node) {
            node._id = node.node().match(key);
        });

        for (var i = 0, l1 = nodes.length - 1; i < l1; i++) {
            for (var j = i + 1, l2 = nodes.length; j < l2; j++) {
                if (nodes[i]._id < nodes[j]._id) {
                    var n = nodes[i];
                    nodes[i] = nodes[j];
                    nodes[j] = n;
                }
            }
        }

        var height = Component.prototype.prefer.height;
        var count = 0;
        nodes.each(function (node) {
            var n = node.node();
            n.position(0, height * count);
            n.show();
            count++;
        });
        this._height = count * height;
    },
    height: function () {
        return this._height;
    },
    show: function () {
        this.view.classed('fold', false);
    },
    hide: function () {
        this.view.classed('fold', true);
    }
});
ComponentGroup.prototype.filter = function (text) {
    this.items.filter(text);
}
ComponentGroup.prototype.direct(function (data) {
    this.items.bind(data);
    this.items.position(0, this.prefer.title);
    this.items.filter('');
});
ComponentGroup.prototype.expand = function () {
    this._expand = !this._expand;
    if (this._expand) {
        this.items.show();
    } else {
        this.items.hide();
    }
    this.container.layout();
}
ComponentGroup.prototype.prefer = {
    width: 200,
    title: 28,
    minwidth: 100,
    'topline-stroke-width': 2
}
ComponentGroup.prototype.position = function (x, y) {
    this.view.attr('transform', sprintf('translate(%f,%f)', x, y));
}
ComponentGroup.prototype.height = function (w) {
    return this.prefer.title + (this._expand ? this.items.height() : 0);
}
ComponentGroup.prototype.width = function (w) {
    this.titlebg.attr('width', w);
    this.topline.attr('d', sprintf('M0,0 l%f,0', w));
    this.text.attr('x', w / 2);

    this.items.width(w);
}
// ==========================
// right menu
// ==========================
function SearchBox(view) {
    var p = this.prefer;

    var w = 200;
    var v = this.view = view.append('g')
            .classed('search', true);

    this.bg = v.append('rect')
            .classed('bg', true)
            .attr({width: w, height: p.height});

    // input
    this.input = v.append('g')
            .classed('key', true)
            .attr('transform', sprintf('translate(%f,%f)', p.padding, p.padding));
    this.inputBg = this.input.append('rect')
            .classed('inputbg', true)
            .attr({
                width: w - p.height - p.padding,
                height: p.height - 2 * p.padding
            });
    this.text = this.input.append('text')
            .attr({'x': p.indent, 'y': p.height, dy: p.dy})
            .text('aabbcc');

    this.button = v.append('rect')
            .classed('button', true)
            .attr({
                width: p.height - 2 * p.padding,
                height: p.height - 2 * p.padding,
                x: w - p.height + p.padding,
                y: p.padding
            })
            .on('click', function () {
                console.log('click');
            });
}
SearchBox.prototype.getInputSize = function () {
    return [0, 0, 0, this.prefer.height];
}
SearchBox.prototype.prefer = {
    height: 28,
    padding: 2,
    indent: 4,
    dy: -9
}
SearchBox.prototype.width = function (w) {
    var p = this.prefer;
    this.bg.attr('width', w);
    this.inputBg.attr('width', w - p.height - p.padding);
    this.button.attr('x', w - p.height + p.padding);
}
SearchBox.prototype.position = function (x, y) {
    this.view.attr('transform', sprintf('translate(%f,%f)', x, y));
}
SearchBox.prototype.height = function () {
    return this.prefer.height;
}
function CompTitle(view) {
    var p = this.prefer;
    this.view = view.append('rect')
            .classed('title', true)
            .attr({width: 200, height: p.height});
}
CompTitle.prototype.width = function (w) {
    this.view.attr('width', w);
}
CompTitle.prototype.height = function () {
    return this.prefer.height;
}
CompTitle.prototype.position = function (x, y) {
    this.view.attr({x: x, y: y});
}
CompTitle.prototype.prefer = {
    height: 12
}
/**
 * @param root parent node
 * @constructor
 */
function ClassManage(root) {
    this.view = root.append('g').classed('classes', true);
    this.bg = this.view.append('rect')
            .classed('bg', true)
            .attr({width: this.prefer.width, height: 0});
    this.root = Node.wrap(this.view);

    this.title = new CompTitle(this.view);

    this.search = new SearchBox(this.view);
    this.search.input.on('mousedown', this.showSearch, this);
    this.search.button.on('click', this.showHistory, this);

    this.input = new TextInput(document.getElementById('search'));
    this.key = '';

    var items = this._default = new ComponentGroup(this, this.root, 'DEFAULT');
    items.bind(config.types);
    this.customers = [new ComponentGroup(this, this.root, 'CUSTOMER')];
    this.customers[0].bind(config.types);

    this.children = collection(
            this.title,
            this.search,
            this._default,
            this.customers);
    this.comps = collection(
            this._default,
            this.customers);

    var _this = this;
    this.area = new Area(0, 0, this.prefer.width, 0);
    this.area.onResize = function () {
        _this.onResize();
    };

    this.layout();
    this.onResize();
}
_extends(ClassManage, Action);
ClassManage.prototype.onResize = function () {
    var w = this.area.width();
    this.bg.attr({width: w, height: this.area.height()});
    this.children.iter(function (e) {
        e.width(w);
    });
}
/**
 * return an area that will be resized
 * @returns {Area}
 */
ClassManage.prototype.getArea = function () {
    return this.area;
}
ClassManage.prototype.component = function (pkg) {
    return new Component(this, this.root, pkg);
}
ClassManage.prototype.showSearch = function () {
    this.input.show(this);
}
ClassManage.prototype.showHistory = function () {
    console.log('showHistory');
}
ClassManage.prototype.prefer = {
    width: 200
}
ClassManage.prototype.layout = function () {
    var h = 0;
    this.children.iter(function (e) {
        e.position(0, h);
        h += e.height();
    });
}
ClassManage.prototype.onRegister = function (manager) {
    console.log('onRegister', manager);
    this.on(ControlType.SVG_DOWN_END);
    this.on(_r(ControlType.SVG_DOWN_END));
}
ClassManage.prototype.filter = function (text) {
    this.comps.iter(function (e) {
        e.filter(text);
    });
    this.layout();
}
ClassManage.prototype.onEvent = function (event) {
    switch (event.id) {
        case _r(ControlType.SVG_DOWN_END):
            this.popupMenu(event);
            break;
        case ControlType.SVG_DOWN_END:
            if (!this.focus) {
                this.stopMenu();
            }
            break;
    }
}
// interact with input
ClassManage.prototype.setText = function (t) {
    var o = this.key;
    this.key = t;
    if (o != t) {
        this.search.text.text(t);
        this.filter(t);
    }
}
ClassManage.prototype.endEdit = function () {
    this.search.input.style('visibility', 'visible');
}
ClassManage.prototype.startEdit = function (input) {
    input.tag().value = this.key;
    input.style('font-size', Math.round(22 * camera.getScale()) + 'px')
            .style('text-indent', Math.round(4 * camera.getScale()) + 'px');
    this.search.input.style('visibility', 'hidden');
}
ClassManage.prototype.getTarget = function () {
    var node = this.search.inputBg;
    return {node: node.tag(), size: [0, 0, node.attr('width'), node.attr('height')]};
}
// ==========================
// Field
// ==========================
function Field(p) {
    Node.call(this, p);
}
_node(Field, Node);
Field.prototype.targetType = Target.FIELD;
Field.prototype.createView = function () {
    return this.rootView().append('svg:g').classed('field', true)
}
Field.prototype.enter = function () {
    var p = Table.prototype.prefer;
    var fw = p.width;
    var fh = p.field.height;
    var fp = p.field.prefix;
    var i = ListNode.prototype.getChildId(this);
    var d = this.data;

    //.on('click', this.handleEdit)
    this.view.on('mousedown', this.handleDown, this)
            .on('mouseover', this.handleOver, this)
            .attr('transform', 'translate(' + 0 + ',' + (fh * i) + ')');

    this.view.append('svg:rect')
            .attr({'width': fw, 'height': fh});

    this.view.append('svg:text')
            .classed('fieldname', true)
            .attr({'x': fp, 'y': fh / 2, 'dy': 6})
            .text(d.name)
    //.on('click', this.handleClick)
}
Field.prototype.update = function (dold, dnew) {
    var d = dnew;
    var ui = this.view;
    ui.select('text')
            .text(d.name);
}
Field.prototype.handleClick = function (d) {
    uiMgr.handle({id: ActionTypes.MOUSE_CLICK, 'target': Node.getNode(d), 'id': 'name'});
}
Field.prototype.handleDown = listenEvent(ActionTypes.MOUSE_DOWN)
Field.prototype.handleOver = listenEvent(ActionTypes.MOUSE_OVER)
Field.prototype.identifier = function (d) {
    return d.type + d.name;
}
Field.prototype.getLinkStart = function () {
    var p = Table.prototype.prefer;
    return [p.width, p.field.height / 2];
}
Field.prototype.getLinkEnd = function () {
    var p = Table.prototype.prefer;
    return [0, p.field.height / 2];
}
Field.prototype.getViewNode = function () {
    return this.view.tag();
}
Field.prototype.getName = function () {
    return this.table.getName() + '.' + this.data.name;
}
// ----------------------
// interact with text input.
Field.prototype.beginInput = function (id, text) {
    text.value = this.data.name;
    this.view.classed('edit', true);
}
Field.prototype.endInput = function (id, text) {
    this.data.name = text.value;
    this.refresh();
    this.view.classed('edit', false);
}
Field.prototype.getSize = function (id) {
    var p = Table.prototype.prefer;
    var fw = p.width;
    var fh = p.field.height;
    return [0, 0, fw, fh];
}
Field.prototype.getNode = function () {
    return this.view.node();
}
/**
 * interact with right click
 * @returns {Array}
 */
Field.prototype.getMenu = function () {
    return [
        {keys: 'L', command: 'table.field.remove'}
    ];
}
Field.prototype.runMenuAction = function (action) {
    switch (action) {
        case 'table.field.remove':
            break;
    }
    console.log(action);
}

// ======================
// Link
// ======================
function Link(p) {
    Node.call(this, p);
    this.id = '';
}
_node(Link, Node);
Link.prototype.targetType = Target.LINK;
Link.prototype.identifier = function (d) {
    return d.from.getId() + '->' + d.to.getId();
}
Link.prototype.cloneData = function (d) {
    return {from: d.from.clone(), to: d.to.clone()};
}
Link.prototype.createView = function () {
    return this.rootView().append('svg:g').classed('link', true);
}
/**
 * this.data {
 *     start(x,y),
 *     end(x,y)
 * }
 */
Link.prototype.enter = function (d) {
    if (this.pointerdis) {
        this.view.attr('pointer-events', 'none');
    }

    this.curve = this.view
            .append('svg:path')
            .classed('curve', true)
            .on('mousedown', this.handleDown, this);
    this.start = this.view.append('svg:circle')
            .classed('start', true)
            .attr('r', 9)
    this.end = this.view
            .append('svg:g');
    this.end.append('svg:path')
            .classed('end', true)
            .attr('d', this.endArc())

    this.id = this.identifier(d);

    this.update(d);
}
Link.prototype.handleDown = listenEvent(ActionTypes.MOUSE_DOWN);
Link.prototype.getId = function () {
    return this.id;
}
Link.prototype.update = function (d) {
    var n1, n2;
    if ((n1 = d.from.node()) && (n2 = d.to.node())) {
        this.show();

        var p1 = camera.transformPoint(n1.getViewNode(), n1.getLinkStart());
        var p2 = camera.transformPoint(n2.getViewNode(), n2.getLinkEnd());
        this.start.attr('cx', p1[0]).attr('cy', p1[1]);
        this.end.attr('transform', 'translate(' + p2[0] + ',' + p2[1] + ')');

        this.updateCurve(p1, p2);
    } else {
        this.hide();
    }
}
Link.prototype.export = function () {
    var n1, n2, d = this.getData();
    var data = {};
    if ((n1 = d.from.node()) && (n2 = d.to.node())) {
        data.start = n1.getName();
        data.end = n2.getName();
        data.type = 'single';
    }
    return data;
}
Link.prototype.updateCurve = function (p1, p2) {
    var gx = p2[0] - p1[0];
    var gy = p2[1] - p1[1];
    var c = Math.max(-Math.min(gx, gy), Math.max(gx, gy)) / 4;

    var path = 'M' + p1[0] + ',' + p1[1]//
    if (gx > 0) {
        path += ' q' + c + ',0' + ' ' + gx / 2 + ',' + gy / 2
        path += ' t' + gx / 2 + ',' + gy / 2;
    } else {
        path += ' q' + -c + ',0' + ' ' + (gx / 2 - c) + ',' + gy / 2
        path += ' t' + (gx / 2 + c) + ',' + gy / 2;
    }

    this.curve.attr('d', path);
    this.start.attr('cx', p1[0]).attr('cy', p1[1]);
    this.end.attr('transform', 'translate(' + p2[0] + ',' + p2[1] + ')');
}
Link.prototype.endArc = d3.svg.arc()
        .innerRadius(0)
        .outerRadius(10)
        .startAngle(-Math.PI)
        .endAngle(0);
Link.prototype.exit = function (d) {
    this.view.remove();
}
Link.prototype.hide = function () {
    this.view.style('visibility', 'hidden');
}
Link.prototype.show = function () {
    this.view.style('visibility', 'visible');
}
Link.prototype.disablePointer = function () {
    this.pointerdis = true;
}
/**
 * menu adapter
 */
Link.prototype.getMenu = function () {
    return [
        {keys: 'L', command: 'link.remove'}
    ];
}
Link.prototype.runMenuAction = function (action) {
    switch (action) {
        case 'link.remove':
            break;
    }
    console.log(action);
}

// ======================
// Table
// ======================
function Table(p) {
    Node.call(this, p);
    this.linkout = [];
    this.linkin = [];
    this.type = '{';
}
_node(Table, Node);
Table.prototype.addLinkOut = function (link) {
    this.linkout.push(link);
}
Table.prototype.addLinkIn = function (link) {
    this.linkin.push(link);
}
Table.prototype.hasLink = function (link) {
    var id = Link.prototype.identifier(link);
    for (var i = 0, links = this.linkout , l = links.length; i < l; i++) {
        if (links[i].getId() == id) {
            return true;
        }
    }
    return false;
}
Table.prototype.rmLinkOut = function (link) {
    var i = this.linkout.indexOf(link);
    if (i != -1) {
        this.linkout.splice(i, 1);
    }
}
Table.prototype.rmLinkIn = function (link) {
    var i = this.linkin.indexOf(link);
    if (i != -1) {
        this.linkin.splice(i, 1);
    }
}
Table.prototype.targetType = Target.TABLE;
/**
 * table 的几种类型 {} [float|int|boolean|double|char] [{}] [{}*]
 * @type {Array}
 */
Table.prototype.types = ['view', 'map', 'table', 'array'];
Table.prototype.prefer = {
    header: {
        height: 45,
        prefix: 8
    },
    field: {
        height: 24,
        prefix: 4
    },
    footer: {
        height: 18
    },
    width: 150
};
Table.prototype.getName = function () {
    return this.data.name;
}
Table.prototype.createView = function () {
    return this.rootView().append('svg:g');
}
Table.prototype.getIcon = function (t) {

}
Table.prototype.enter = function (d) {
    var p = this.prefer.header;
    var w = this.prefer.width;

    // view
    this.view.attr('transform', 'translate(' + d.position.x + ',' + d.position.y + ')')
            .classed('table', true)
            .classed(d.type, true)
            .on('mousedown', this.handleDown, this);

    // header
    this.header = this.view
            .append('svg:g')
            .on('mousedown', this.handleDown, this)
            .on('mouseover', this.handleOver, true, this)
    this.header.append('svg:rect')
            .attr('width', this.prefer.width)
            .attr('height', p.height)
            .classed('header', true);

    this.title = this.header.append('svg:text')
            .attr({
                x: p.prefix,
                y: p.height / 2,
                dy: 8
            })
            .classed('headername', true)
            .text(d.name);
    this.typetext = this.header.append('svg:text')
            .attr({
                x: this.prefer.width - 15,
                y: p.height / 2,
                dy: 13
            })
            .classed('type', true)
            .text('{');

// fields
    var fieldsBg = this.view.append('svg:g')
            .attr("transform", 'translate(0,' + p.height + ')')
            .classed('fields', true)
            .on('mousedown', this.handleDown, this)
            .on('mouseover', this.handleOver, true, this)

    this.fields = new Fields(this, fieldsBg);
    this.fields.bind(d.fields);
    this.fields.bind(d.fields);

// footer
    p = this.prefer.footer;
    this.footer = this.view.append('svg:rect')
            .attr('width', w)
            .attr('height', p.height)
            .attr('y', this.getHeight() - p.height)
            .classed('footer', true);
}
;
Table.prototype.update = function (dold, dnew) {
    var d = dnew;

    this.title.text(d.name);

    this.fields.bind(dnew.fields);

    var p = this.footer;
    this.footer
            .attr('y', this.getHeight() - p.height)
            .classed('footer', true);
};
Table.prototype.getHeight = function () {
    var d = this.data;
    var p = this.prefer;
    return d.fields.length * p.field.height + p.header.height + p.footer.height;
};
Table.prototype.handleDown = listenEvent(ActionTypes.MOUSE_DOWN);
Table.prototype.handleOver = listenEvent(ActionTypes.MOUSE_OVER);
Table.prototype.isTable = function (t) {
    return this.types.indexOf(t) != -1;
};
Table.prototype.hasField = function (f) {
    if (!f) {
        return false;
    }
    for (var i = 0, fs = this.data.fields, l = fs.length; i < l; i++) {
        if (fs[i] === f.data) {
            return true;
        }
    }
    return false;
};
Table.prototype.getField = function (name) {
    return this.fields.getField(name);
};
/**
 * get relative start to this table
 */
Table.prototype.getLinkStart = function () {
    var p = this.prefer;
    return [p.width, p.header.height / 2];
};
Table.prototype.getLinkEnd = function () {
    var p = this.prefer;
    return [0, p.header.height / 2];
};
Table.prototype.getViewNode = function () {
    return this.view.tag();
};

// interact with menu
Table.prototype.getMenu = function () {
    return [
        {keys: '', command: 'table.remove'},
        {keys: 'R', command: 'table.rename'},
        {keys: 'F', command: 'table.field.add'}
    ];
}
Table.prototype.runMenuAction = function (action) {
    switch (action) {
        case 'table.remove':
            break;
        case 'table.rename':
            break;
        case 'table.add.field':
            break;
    }
    console.log(action);
}
Table.prototype.getMoveFeature = function () {
    var table = this;
    var links = [].concat(this.linkout).concat(this.linkin);
    return new (_extends(function () {
        MoveAdapter.call(this, table.data.position, table.view);
    }, MoveAdapter, {
        startMove: function (x, y) {
            MoveAdapter.prototype.startMove.call(this, x, y);
            table.view.classed('focus', true);
        },
        moveTo: function (x, y) {
            MoveAdapter.prototype.moveTo.call(this, x, y);
            // update link terminate when moving the table
            for (var i = 0, l = links.length; i < l; i++) {
                links[i].refresh();
            }
        },
        stopMove: function (x, y) {
            table.view.classed('focus', false);
        }
    }))();
}
/**
 * interact with global function
 * @param f
 * @returns {*}
 */
Table.prototype.getFeature = function (f) {
    switch (f) {
        case 'move':
            return this.getMoveFeature();
        default :
            console.error('Unsupported feature found:' + f);
            return null;
    }
}
Table.prototype.export = function () {
    var td = this.data;
    td.fields = this.fields.export();// update field
    return td;
}
// ==========================
// container types
// ==========================
var Fields = Node.createContainer(Field, {
    getField: function (name) {
        var f;
        this.getChildren().iterator(function (node) {
            if (node.node().getData().name == name) {
                f = node.node();
                return false;
            }
        });
        return f;
    },
    export: function () {
        var data = [];
        this.getChildren().each(function (node) {
            data.push(node.node().getData())
        });
        return data;
    },
    createChild: function () {
        var child = new Field(this);
        child.create();
        child.table = this.parentNode;
        return child;
    }
});

// ==========================
// schema layer
// ==========================
function TableCollection(p, view) {
    ListNode.call(this, p);
    this.view = view;
}
_extends(TableCollection, ListNode);
/**
 * sort links and tables
 * @param table current focus table
 */
TableCollection.prototype.order = function (table) {
    var tables = this.view.selectAll('g.entity > g');
    var nodes = tables.nodes();
    var z = 0;
    var t;
    var tnode;
    for (var i = 0, l = nodes.length; i < l; i++) {
        if ((t = nodes[i].node()) instanceof Table) {
            if (t === table) {
                nodes.push(tnode = nodes[i]);
                nodes.splice(i, 1);
                i--;
                l--;
            } else {
                nodes[i].zindex = z++;
            }
        }
    }
    tnode && (tnode.zindex = z);
    tables.order();
}
TableCollection.prototype.getChildren = function () {
    return this.view.selectAll('g > .table');
}
TableCollection.prototype.createChild = function () {
    return Table.create(this);
}
TableCollection.prototype.identifier = Table.identifier;
TableCollection.prototype.export = function () {
    var data = [];
    this.getChildren().each(function (node) {
        data.push(node.node().export());
    });
    return data;
}
function LinkCollection(p, view) {
    ListNode.call(this, p);
    this.view = view;
}
Node.createContainer(Link, {
    constructor: LinkCollection
});
LinkCollection.prototype.createChild = function () {
    return Link.create(this);
}
LinkCollection.prototype.identifier = Link.identifier;
LinkCollection.prototype.getChildren = function () {
    return this.view.selectAll('g > .link');
}
LinkCollection.prototype.export = function () {
    var data = [];
    this.getChildren().each(function (link) {
        data.push(link.node().export());
    })
    return data;
}
// ======================
// camera
// ======================
function Camera(viewbox, bg) {
    this.viewbox = viewbox;
    this.bg = bg;

    // window size
    this.width = 0;
    this.height = 0;
    // coordinate scale
    this.scalef = 1;
    // coordinate start
    this.startx = 0;
    this.starty = 0;
}
/**
 * drag end
 * @param mx
 * @param my
 */
Camera.prototype.move = function (mx, my) {
    this.startx -= mx / this.scalef;
    this.starty -= my / this.scalef;
    this.viewbox.attr('viewBox', sprintf('%f %f %f %f',
            this.startx,
            this.starty,
            this.width / this.scalef,
            this.height / this.scalef));
}
Camera.prototype.apply = function (sx, sy) {
    if (arguments.length == 0) {
        sx = this.startx;
        sy = this.starty;
    }
    var w = this.width / this.scalef;
    var h = this.height / this.scalef;
    this.viewbox.attr('viewBox', sprintf('%f %f %f %f', sx, sy, w, h));
    this.rect.attr({x: sx, y: sy, width: w, height: h});
}
/**
 * during the drag movment
 * @param mx
 * @param my
 */
Camera.prototype.moving = function (mx, my) {
    var sx = this.startx - mx / this.scalef;
    var sy = this.starty - my / this.scalef;
    this.apply(sx, sy);
}
/**
 * when user resize the browser
 *
 * @param width
 * @param height
 */
Camera.prototype.resize = function (width, height) {
    this.width = width;
    this.height = height;
    this.viewbox.attr({width: this.width, height: this.height});
    this.apply();
}
/**
 * 对屏幕上指定的点缩放
 *
 * @param scalef
 * @param currentx
 * @param currenty
 */
Camera.prototype.scale = function (scalef, currentx, currenty) {
    this.scalef = scalef;
    if (arguments.length == 3) {
    }
    this.apply();
}
Camera.prototype.transformPoint = function (g, p) {
    var svgM = g.getTransformToElement(global.root);

    var matrix = mat2d.create();

    // apply child transform
    mat2d.multiply(matrix, matrix, mat2d.clone([svgM.a, svgM.b, svgM.c, svgM.d, svgM.e, svgM.f]));
    // apply camera transform
    mat2d.translate(matrix, matrix, vec2.clone([-this.x, -this.y]));
    mat2d.scale(matrix, matrix, vec2.clone([this.scalef, this.scalef]));

    // convert point on child to world
    var world = vec2.clone(p);
    vec2.transformMat2d(world, world, matrix);
    return world;
}
Camera.prototype.toLocal = function (x, y) {
    return [x, y];
}
Camera.prototype.transform = function (g, size) {
    var svgM = g.getTransformToElement(global.root);

    var matrix = mat2d.create();

    // apply child transform
    mat2d.multiply(matrix, matrix, mat2d.clone([svgM.a, svgM.b, svgM.c, svgM.d, svgM.e, svgM.f]));
    // apply camera transform
    mat2d.translate(matrix, matrix, vec2.clone([-this.x, -this.y]));
    mat2d.scale(matrix, matrix, vec2.clone([this.scalef, this.scalef]));

    // convert point on child to world
    var world = vec2.clone(size);
    vec2.transformMat2d(world, world, matrix);
    var x = world[0];
    var y = world[1];

    vec2.set(world, size[0] + size[2], size[1] + size[3]);
    vec2.transformMat2d(world, world, matrix);

    return [x, y, world[0] - x, world[1] - y];
}
// ======================
// Menu
// ======================
function Menu(p, action) {
    Node.call(this, p);
    this.action = action;
}
_node(Menu, Node);
Menu.prototype.prefer = {
    width: 170,
    height: 20,
    splitheight: 5,
    padding: 4
}
Menu.prototype.createView = function () {
    return this.rootView()
            .append('svg:g')
            .classed('menu', true)
            .on('mousedown', this.handleDown, this);
}
Menu.prototype.bind = function (data) {
    this.view.remove('g > *');

    var p = this.prefer;
    var menuy = 0;
    for (var i = 0, l = data.length; i < l; i++) {
        var item = data[i];

        if (item.split) {
            var cy = menuy + p.splitheight / 2;
            this.view.append('svg:rect')
                    .attr('width', p.width)
                    .attr('height', p.splitheight)
                    .attr('y', menuy)
                    .classed('split', true);
            this.view.append('svg:path')
                    .attr('d', 'M' + p.padding + ',' + cy + 'L' + (p.width - p.padding) + ',' + cy);
            menuy += p.splitheight;
        } else {
            item.action = this.action;
            var g = this.view.append('svg:g')
                    .attr('transform', 'translate(' + 0 + ',' + menuy + ')')
                    .classed('item', true)
                    .on('click', this.handleClick, item);
            g.append('svg:rect')
                    .attr('width', p.width)
                    .attr('height', p.height)
            g.append('svg:text')
                    .attr('x', p.padding)
                    .attr('y', p.height - 4)
                    .text(item.title || config.string(item.command));
            menuy += p.height;
        }
    }

    this.view.insert('svg:rect', ':first-child')
            .attr('width', p.width)
            .attr('height', menuy)
            .classed('background', true)
    this.height = menuy;
}
Menu.prototype.handleClick = function (d) {
    this.action.onMenuClick(this.command);
}
Menu.prototype.handleDown = function () {
    if (block.event.button == 2) {
        block.event.stopPropagation();
    }
    this.action.onMenuDown();
}
Menu.prototype.show = function (x, y, items) {
    this.bind(items);
    this.showprevious(x, y);
}
Menu.prototype.showprevious = function (x, y) {
    this.view.attr('transform', 'translate(' + x + ',' + y + ')');
    this.view.style('visibility', 'visible');
}
Menu.prototype.hide = function () {
    this.view.style('visibility', 'hidden');
}
/**
 * menu when you click at an empty space
 * @constructor
 */
function DefaltMenu() {
}
DefaltMenu.prototype.getMenu = function () {
    return [
        {keys: 'A', command: 'global.add.table'},
        {keys: '', command: 'global.export'},
        {keys: '', command: 'global.save'}
    ];
}
DefaltMenu.prototype.runMenuAction = function (action) {
    switch (action) {
        case 'global.add.table':
            break;
        case 'global.export':
        case 'global.save':
            var exp = uiMgr.export();
            d3.xhr('res/data.json?save=true').post(JSON.encode(exp), function () {
                console.log('upload success', arguments);
            });
            console.log(JSON.encode(exp));
            break;
    }
    console.log(action);
}
function MenuAction(layer) {
    Action.call(this);

    this.initEvent = _r(ControlType.SVG_DOWN_END);
    this.focus = false;
    this.target = null;
    this.backmenu = new DefaltMenu();

    this.menu = Menu.create(layer, this);
}
_extends(MenuAction, Action);
MenuAction.prototype.onRegister = function (manager) {
    this.on(ControlType.SVG_DOWN_END);
    this.on(_r(ControlType.SVG_DOWN_END));
}
MenuAction.prototype.onEvent = function (event) {
    switch (event.id) {
        case _r(ControlType.SVG_DOWN_END):
            this.popupMenu(event);
            break;
        case ControlType.SVG_DOWN_END:
            if (!this.focus) {
                this.stopMenu();
            }
            break;
    }
}
/**
 * popup right click menu
 * @param event
 */
MenuAction.prototype.popupMenu = function (event) {
    this.focus = false;

    // if table menu
    var target = this.checkTarget(event, 'mousedown.link', 'mousedown.field', 'mousedown.table');
    target = target || this.backmenu;

    // change position
    if (target === this.target) {
        this.menu.showprevious(block.event.x, block.event.y);
        return;
    }
    this.target = target;
    this.menu.show(block.event.x, block.event.y, target.getMenu());
    this.active = true;
}
MenuAction.prototype.checkTarget = function (event) {
    var t;
    for (var i = 1, l = arguments.length; i < l; i++) {
        if (t = this.getParam(event, arguments[i])) {
            return t;
        }
    }
    return null;
}
MenuAction.prototype.onMenuClick = function (command) {
    this.target.runMenuAction(command);
    this.stopMenu();
}
MenuAction.prototype.onMenuDown = function () {
    this.focus = true;
}
MenuAction.prototype.stopMenu = function () {
    this.menu.hide();
    this.target = null;
}
// ==========================
// Component panel
// ==========================
function ComponentBoard() {
}
_extends(ComponentBoard, ListNode);
// ==========================
// Edit Area
// ==========================
function EditArea(root) {
    this.view = root.append('g').classed('tables', true);

    this.viewbox = this.view.append('svg');
    this.rect = this.viewbox.append('svg:rect')
            .attr('fill', 'url(#gridPattern)')
            .on('mouseout', this.handleOut)
            .on('mouseover', this.handleOver);
    this.camera = new Camera(this.viewbox, this.rect);
    this.area = new Area();
}
EditArea.prototype.getArea = function () {
    return this.area;
}
/**
 * 离开背景图片, 进入到各种 UI 界面
 */
EditArea.prototype.handleOut = function () {
    uiMgr.handleEvent({id: ControlType.SVG_BG_OUT})
}
/**
 * 鼠标从一个 UI 控件上离开
 */
EditArea.prototype.handleOver = function () {
    uiMgr.handleEvent({id: ControlType.SVG_BG_OVER})
}
// ==========================
// UI Manager
// ==========================
function UIManager(svg) {
    this.svg = svg;

    // listener binding
    this.controlListener = new DataMap();
    for (var i in ControlType) {
        this.controlListener.value(ControlType[i], []);
    }
    this.userListener = new DataMap();

    // init record
    this.eventRecord = new DataMap();
    for (var action in ActionTypes) {
        this.eventRecord.value(ActionTypes[action], {});
    }

    // ui drawing layers
    this.layers = {
        schema: Node.wrap(svg.append('svg:g').classed('entity', true)),
        assistant: Node.wrap(svg.append('svg:g').classed('pAssistant', true)),
        dialog: Node.wrap(svg.append('svg:g').classed('pDialog', true)),
        panels: svg.append('svg:g').classed('pPanel', true),
        message: Node.wrap(svg.append('svg:g').classed('pMessage', true))
    };

    // all tables
    this.tables = new TableCollection(this.layers.schema, this.layers.schema.view);
    this.links = new LinkCollection(this.layers.schema, this.layers.schema.view);

    // hold the whole ui layout
    this.areas = new LinerLayout();
    // all registered actions
    this.actions = {};
    // all parts
    this.components = {};

    this.init();
//    svg.append('path')
//            .attr('d', 'm 9.4512443,0.05844875 c -0.121534,0.017841 -0.512253,0.075447 -0.868266,0.128016 -2.691328,0.397399 -4.442499,1.94247005 -5.07177,4.47485905 -0.159084,0.640207 -0.19233,1.024724 -0.189415,2.190713 0.0019,0.777818 0.0474,1.732412 0.101017,2.12132 0.05362,0.388909 0.206526,1.4827152 0.339802,2.4306802 0.181309,1.289612 0.243499,2.09077 0.247005,3.18198 0.0043,1.338389 -0.0127,1.501684 -0.206605,1.984268 -0.261445,0.650685 -0.854682,1.299738 -1.457564,1.594701 -0.496012,0.242676 -1.49607599,0.482933 -2.02030099,0.485361 l -0.331456,0.0015 0,1.281632 0,1.281631 0.35728,0 c 0.615297,0 1.69837899,0.268653 2.23710799,0.554904 0.598945,0.31828 1.033042,0.834113 1.267502,1.506189 0.269496,0.772509 0.211244,3.165156 -0.134887,5.540338 -0.506054,3.472587 -0.552336,4.747693 -0.225758,6.219728 0.366804,1.653349 1.39654,2.948355 2.951105,3.711338 0.461829,0.226666 1.156587,0.49186 1.543908,0.589319 0.729467,0.183552 2.2455597,0.34931 3.2069657,0.350626 l 0.552427,7.56e-4 0,-1.401079 0,-1.401078 -0.994369,-0.05407 C 8.5220473,36.710676 7.5216163,36.045698 7.0069643,34.340813 c -0.281635,-0.932969 -0.217438,-2.908483 0.180922,-5.567515 0.508605,-3.394917 0.447792,-4.95119 -0.24872,-6.364912 -0.167656,-0.340295 -0.447292,-0.78491 -0.621413,-0.988034 -0.405527,-0.473073 -1.242302,-1.031462 -1.911168,-1.275342 -0.288094,-0.105044 -0.523751,-0.215492 -0.523684,-0.245438 6.7e-5,-0.02995 0.228824,-0.121646 0.508349,-0.203777 0.641151,-0.188386 1.474002,-0.722958 1.913991,-1.228509 0.186648,-0.214461 0.474029,-0.669751 0.638624,-1.011757 0.688296,-1.430187 0.750981,-3.018652 0.254503,-6.44924 -0.371054,-2.5639332 -0.463756,-3.9727032 -0.321216,-4.8814512 0.351462,-2.240704 1.502226,-3.225865 3.9220147,-3.35761 l 0.950175,-0.05173 0,-1.356778 0,-1.35677805 -1.038563,0.01204 c -0.57121,0.0066 -1.1380007,0.02663 -1.2595347,0.04447 l 0,0 z')
//            .attr('style', 'fill:black;');
//    var comp = Component.create(this.layers.panels);
//    comp.bind(config.types[0]);
}
UIManager.prototype.init = function () {
    var tables, classes;
    this.addAction('tables', new TableAction(this.tables));
    this.addAction('drag', new DragAction());
    this.addAction('link', new LinkAction(this));
    this.addAction('menu', new MenuAction(this.layers.dialog));
    this.addAction('classes', new ClassManage(this.layers.panels));

    this.areas.add(this.actions['classes'].getArea(), 0);
    this.areas.add(this.actions['tables'].getArea(), 1);
}
UIManager.prototype.dispatchEvent = function (evt) {
    var n = this.layers.schema.node();
    n.dispatchEvent(evt);
}
UIManager.prototype.getLinkNode = function (tables, nodeid) {
    var parts = (nodeid || '').split('.');
    if (parts.length == 0) {
        return null;
    }
    var table = tables.get(parts[0]);
    if (!table) {
        return null;
    }

    var p = new LinkTerminal();
    p.table(table);

    if (parts.length == 2) {
        var field = table.getField(parts[1]);
        if (!field) {
            return null;
        } else {
            p.field(field);
        }
    }

    p.updatetype();
    return p;
}
UIManager.prototype.bindEntity = function (data) {
    var ts = data.tables;
    this.tables.bind(data.tables);

    // map all table nodes
    var tmap = new d3.map();
    this.tables.getChildren().each(function (node, i) {
        (node = node.node()) && tmap.set(ts[i].name, node);
    });

    // create link
    var link;
    for (var i = 0, ls = data.links, len = ls.length; i < len; i++) {
        link = ls[i];
        var p1, p2;
        if ((p1 = this.getLinkNode(tmap, link.start)) && (p2 = this.getLinkNode(tmap, link.end))) {
            link = this.links.bindChild({from: p1, to: p2});
            p1.table().addLinkOut(link);
            p2.table().addLinkIn(link);
        }
    }
}
UIManager.prototype.bindDatas = function (data) {
    this.bindEntity(data.entities);
}
UIManager.prototype.addComponent = function (name, comp) {
    this.components[name] = comp;
}
UIManager.prototype.addAction = function (name, action) {
    action.register(this);
    this.actions[name] = action;
}
UIManager.prototype.on = function (key, action) {
    if (key in ControlKeys) {
        var ls = this.controlListener.value(key);
        if (ls.indexOf(action) == -1) {
            ls.push(action);
        }
        return;
    }
    var ls = this.userListener.value(key);
    if (!ls) {
        this.userListener.value(key, ls = []);
        ls.push(action);
    } else {
        if (ls.indexOf(action) == -1) {
            ls.push(action);
        }
    }
}
UIManager.prototype.off = function (key, action) {
    if (key in ControlKeys) {
        this.controlListener.value(key).erase(action);
        return;
    }
    var ls = this.userListener.value(key);
    if (!ls) {
        ls.erase(action);
        if (ls.length == 0) {
            this.userListener.del(key);
        }
    }
}
UIManager.prototype.runEvent = function (event, actions) {
    if (!actions) {
        return;
    }
    for (var i = 0, l = actions.length, a; i < l; i++) {
        a = actions[i];
        (a.initEvent == event.id || a.isActive()) && a.onEvent(event);
    }
}
UIManager.prototype.runUserEvent = function (event, actions) {
    if (!actions) {
        return;
    }
    for (var i = 0, l = actions.length, a; i < l; i++) {
        a = actions[i];
        (a.initEvent == event.id || a.isActive()) && a.onUserEvent(event);
    }
}
UIManager.prototype.ctrlKey = function () {
    return block.event.metaKey || block.event.ctrlKey;
}
UIManager.prototype.loseFocus = function () {
    block.selectAll('.focus')
            .classed('focus', false);
}
UIManager.prototype.onFocus = function (param) {
//    this.input.close();
//    var d = param.target.data;
//    if (Table.prototype.isTable(d.type) != -1) {
//        tables.order();
//    }
}
/**
 * handle event on svg root element
 * @param p
 */
UIManager.prototype.handleEvent = function (p) {
    if (block.event.button == 2) {
        p.id += '_r';
    }
    switch (p.id) {
        case ControlType.SVG_BG_OUT:
        case _r(ControlType.SVG_BG_OUT):
        case ControlType.SVG_BG_OVER:
        case _r(ControlType.SVG_BG_OVER):
            this.eventRecord.clean(ActionTypes.MOUSE_OVER);
            break;
        case ControlType.SVG_DOWN_BEGIN:
        case _r(ControlType.SVG_DOWN_BEGIN):
            this.eventRecord.clean(ActionTypes.MOUSE_DOWN);
            break;
    }

    p.param = this.eventRecord;
    this.runEvent(p, this.controlListener.value(p.id));
}
UIManager.prototype.handleUserEvent = function (p) {
    this.runUserEvent(p, this.userListener.value(p.id));
}
UIManager.prototype.handleSpecial = {
    // if table change clean field TODO
    'mouseover.table': function (p) {
        var d = this.eventRecord;
        if (p.target !== d.value('mouseover.table')) {
            d.value('mouseover.table', p.target);
            d.del('mouseover.field');
        }
    }
}
/**
 * handle event generated on view elements
 * @param param
 */
UIManager.prototype.handle = function (param) {
    var t = param.target;
    var d = this.eventRecord;

    var speId = join(param.id, t.targetType);
    var f;
    if (f = this.handleSpecial[speId]) {
        f.call(this, param);
    } else {
        d.value(speId, t);
    }
}
UIManager.prototype.globalKey = function () {
    console.log(block.event);
}
UIManager.prototype.createLink = function () {
    return Link.create(this.layers.assistant);
}
UIManager.prototype.addLink = function (d) {
    var fromt = d.from.table();
    var tot = d.to.table();
    if (fromt && !fromt.hasLink(d) && tot) {
        d = Link.prototype.cloneData(d);
        var link = this.links.bindChild(d);
        fromt.addLinkOut(link);
        tot.addLinkIn(link);

        console.log(link.getId());
    }
}
UIManager.prototype.export = function () {
    var save = {};
    save.entities = this.exportEntity();
    return save;
}
UIManager.prototype.exportEntity = function () {
    var data = {};
    data.tables = this.tables.export();
    data.links = this.links.export();
    return data;
}
UIManager.prototype.onResize = function (w, h) {
    // the whole export of svg visiable area
    this.svg.attr('viewBox', '0 0 ' + w + ' ' + h)
            .attr('width', w)
            .attr('height', h);
    // separated panel resize
    this.areas.size(w, h);
}
// ==========================
// TextInput
// ==========================
function TextInput(div) {
    this.div = block.select(div);
    this.input = block.select(div.getElementsByTagName('input')[0])
            .on('change', this.submit, this)
            .on('input', this.submit, this)
            .on('blur', this.hide, this)
}
TextInput.prototype.submit = function () {
    var a = this.adapter;
    if (a) {
        a.setText(this.input.tag().value);
    }
}
TextInput.prototype.hide = function () {
    this.submit();
    var a = this.adapter;
    if (a) {
        a.endEdit();
    }
    this.div.style('visibility', 'hidden');
}
/**
 * @param adapter will interact with html text input tag
 *     {getNode, getText, setText}
 */
TextInput.prototype.show = function (adapter) {
    if (!adapter) {
        return;
    }

    this.adapter = adapter;
    var target = adapter.getTarget();
    var size = camera.transform(target.node, target.size);

    adapter.startEdit(this.input);
    this.div.style({
        'left': size[0] + 'px',
        'top': size[1] + 'px',
        'width': size[2] + 'px',
        'height': size[3] + 'px'});
    this.div.style('visibility', 'visible');
}
// ==========================
// DragControl
// ==========================
function DragAction() {
    Action.call(this);
    this.initEvent = ControlType.SVG_DOWN_END;
}
_extends(DragAction, Action);
DragAction.prototype.onRegister = function (manager) {
    this.on(ControlType.SVG_DOWN_END);
    this.on(ControlType.SVG_MOVE);
    this.on(ControlType.SVG_UP_END);
    this.on('link.begin');
}
DragAction.prototype.inactive = function () {
    this.active = false;
    var n = this.node;
    if (n) {
        n.stopMove(block.event.x, block.event.y);
        this.node = null;
    }
}
DragAction.prototype.onEvent = function (event) {
    switch (event.id) {
        case ControlType.SVG_DOWN_END:
            this.inactive();

            // if user release the ctrl key, stop dragging
            if (!UIManager.prototype.ctrlKey()) {
                break;
            }

            var target = this.getParam(event, 'mousedown.table');
            if (target) {
                this.node = target.getFeature('move');
                this.node.startMove(block.event.x, block.event.y);
                this.active = true;
                this.fireEvent('drag.begin', target);
            } else {
                // TODO drag camera
            }
            break;

        case ControlType.SVG_MOVE:
            if (!UIManager.prototype.ctrlKey()) {
                this.inactive();
                break;
            }
            this.node.moveTo(block.event.x, block.event.y);
            break;

        case ControlType.SVG_UP_END:
            this.inactive();
            break;
    }
}
DragAction.prototype.onUserEvent = function (event) {
    switch (event.id) {
        case 'link.begin':
            this.inactive();
            break;
    }
}
// ==========================
// Link curve
// ==========================
function LinkTerminal() {
    this.type = this.Types.NONE;
}
LinkTerminal.prototype.table = function () {
    var t;
    if (t = arguments[0]) {
        if (this.mtable !== t) {
            delete this.mfield;
        }
        this.mtable = t;
        this.updatetype();
    } else {
        return this.mtable;
    }
}
LinkTerminal.prototype.getId = function () {
    var id;
    var t;
    if (t = this.table()) {
        id = t.getName();
    } else {
        id = '';
    }
    if (t = this.field()) {
        id += '.' + t.getName();
    }
    return id;
}
LinkTerminal.prototype.field = function () {
    var t;
    if (t = arguments[0]) {
        this.mfield = t;
        this.updatetype();
    } else {
        return this.mfield
    }
}
LinkTerminal.prototype.delfield = function () {
    delete this.mfield;
}
LinkTerminal.prototype.deltable = function () {
    delete this.mtable;
}
LinkTerminal.prototype.node = function () {
    return this.type != this.Types.NONE && (this.mfield || this.mtable);
}
LinkTerminal.prototype.updatetype = function () {
    if (this.mfield) {
        this.type = this.Types.FIELD;
    } else if (this.mtable) {
        this.type = this.Types.TABLE;
    }
}
LinkTerminal.prototype.reset = function () {
    delete this.mfield;
    delete this.mtable;
    this.type = this.Types.NONE;
}
LinkTerminal.prototype.Types = {
    TABLE: 'table',
    FIELD: 'field',
    NONE: 'none'
}
LinkTerminal.prototype.clone = function () {
    var t = new LinkTerminal();
    if (this.mtable) {
        t.mtable = this.mtable;
    }
    if (this.mfield) {
        t.mfield = this.mfield;
    }
    t.type = this.type;
    return t;
}
// ==========================
// LinkAction
// ==========================
function LinkAction(manager) {
    Action.call(this);

    this.link = manager.createLink();
    this.link.disablePointer();
    this.data = {
        from: new LinkTerminal(),
        to: new LinkTerminal()
    };
    this.link.bind(this.data);
}
_extends(LinkAction, Action);
LinkAction.prototype.onRegister = function (manager) {
    this.initEvent = ControlType.SVG_DOWN_END;
    this.on(ControlType.SVG_DOWN_END);
    this.on(ControlType.SVG_MOVE);
    this.on(ControlType.SVG_UP_END);
}
LinkAction.prototype.inactive = function () {
    this.active = false;
    this.data.from.reset();
    this.data.to.reset();
    this.link.hide();
}
LinkAction.prototype.onEvent = function (event) {
    switch (event.id) {
        case ControlType.SVG_DOWN_END:
            this.inactive();

            // if user release the ctrl key, stop dragging
            if (UIManager.prototype.ctrlKey()) {
                break;
            }

            this.start(event);
            break;

        case ControlType.SVG_MOVE:
            if (UIManager.prototype.ctrlKey()) {
                this.inactive();
                break;
            }

            this.updateEnd(event);
            break;

        case ControlType.SVG_UP_END:
            this.addLink();
            break;
    }
}
LinkAction.prototype.addLink = function () {
    var d = this.data;
    var endt = d.to.table();
    if (endt) {
        uiMgr.addLink(d);
    }
    this.inactive();
}
LinkAction.prototype.updateEnd = function (event) {
    var d = this.data.to;

    var table = this.getParam(event, 'mouseover.table');
    if (table && table != this.data.from.table()) {
        d.table(table);
        var field = this.getParam(event, 'mouseover.field');
        if (field) {
            d.field(field);
        } else {
            d.delfield();
        }
    } else {
        d.reset();
    }

    var n = d.node();
    if (n) {
        this.dragend = camera.transformPoint(n.getViewNode(), n.getLinkEnd());
    } else {
        this.dragend = camera.toLocal(block.event.x, block.event.y);
    }

    this.link.updateCurve(this.dragstart, this.dragend);
    this.link.show();
}
LinkAction.prototype.start = function (event) {
    var d = this.data.from;
    d.reset();

    var table = this.getParam(event, 'mousedown.table');
    if (!table) {
        return;
    }

    d.table(table);
    var field = this.getParam(event, 'mousedown.field');
    if (field) {
        d.field(field);
    }
    d.updatetype();
    var n = d.node();
    this.dragstart = camera.transformPoint(n.getViewNode(), n.getLinkStart());

    this.active = true;
    this.fireEvent('link.begin', this.beginTable);
}

// ==========================
// TableAction
// ==========================
function TableAction(tables) {
    Action.call(this);
    this.tables = tables;
    this.initEvent = 'drag.begin';
    this.area = new Area();
    var table = this;
    this.area.onResize = function () {
        table.onResize();
    }
}
_extends(TableAction, Action);
TableAction.prototype.onResize = function () {
    console.log(this.area);
}
TableAction.prototype.onRegister = function (manager) {
    manager.on('drag.begin', this);
}
TableAction.prototype.onUserEvent = function (event) {
    switch (event.id) {
        case 'drag.begin':
            // console.log(event);
            this.tables.order(event.param);
            break;
    }
}
TableAction.prototype.getArea = function () {
    return this.area;
}
// ======================
// global
// ======================
/**
 * declear svg defs
 * @param svg
 */
function initDefs(svg) {
    // bg fill
    var defs = svg.append('svg:defs');
    defs.append('svg:pattern')
            .attr('id', 'gridPattern')
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', 15)
            .attr('height', 15)
            .attr('patternUnits', 'userSpaceOnUse')
            .append('svg:path')
            .attr('d', 'M 15 0 L 0 0 0 15')
            .attr('fill', 'none')
            .attr('stroke', '#6DA0A1')
            .attr('stroke-width', '0.25');
    // shadow
    var dropshadow = defs.append('svg:filter')
            .attr('id', 'dropshadow')
            .attr('height', '130%');
    dropshadow.append('svg:feGaussianBlur')
            .attr('in', 'SourceAlpha')
            .attr('stdDeviation', '2');
    dropshadow.append('svg:feOffset')
            .attr('dx', '2')
            .attr('dy', '2')
            .attr('result', 'offsetblur');
    var feMerge = dropshadow.append('svg:feMerge')
    feMerge.append('svg:feMergeNode');
    feMerge.append('svg:feMergeNode').attr('in', 'SourceGraphic');
}

var svg = block.select('.chart')
        .append('svg')
        .attr({
            width: window.innerHeight,
            height: window.innerHeight,
            id: 'svg'
        });
initDefs(svg);

var global = {
    root: document.getElementById('svg')
}

//var camera = new Camera(svg);
var uiMgr = new UIManager(svg);

svg.on('mousedown.start', listenSvg(ControlType.SVG_DOWN_BEGIN), true);
svg.on('mousedown.end', listenSvg(ControlType.SVG_DOWN_END));
svg.on('mousemove', listenSvg(ControlType.SVG_MOVE), true);
svg.on('mouseup.start', listenSvg(ControlType.SVG_UP_BEGIN), true);
svg.on('mouseup.end', listenSvg(ControlType.SVG_UP_END));

// global listeners register
window.addEventListener('resize', function () {
    var width = window.innerWidth;
    var height = window.innerHeight;
//    camera.setStart(-100, 50);
//    camera.scale(1.2, 0, 0);
//    camera.apply();
    uiMgr.onResize(width, height);
});
uiMgr.onResize(window.innerWidth, window.innerHeight);

// ==========================
// binding data
// ==========================
d3.json('res/data.json', function (data) {
//    uiMgr.bindDatas(data);
});

// ==========================
// disable chrome plugins
// ==========================
function keyListener() {
//    console.log('document.onkeydown', this, arguments);
}

function menuListener() {
    return false;
}
var tt = setInterval(function () {
    var check = ['onkeydown', 'onkeyup', 'onmousedown', 'onmousemove', 'onmouseout', 'onmouseover', 'onmouseup', 'ondblclick', 'onclick', 'onkeypress'];
    document.onkeydown = keyListener;
    document.oncontextmenu = menuListener;
    clearInterval(tt);
}, 2000);

block.select(document);
block.select(document.querySelector('.chart'));

//var liner = new LinerLayout(100, 50, 500, 400, 'h');
//var a, b;
//liner.add(a = new Area(0, 0, 100, 100));
//liner.add(b = new Area(0, 0, 100, 100), 1);
//liner.refresh();
//console.log(a, b, liner);
//
//liner.setWidth(550);
//console.log(a, b, liner);

</script>
</body>
</html>